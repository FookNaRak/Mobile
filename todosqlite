import 'package:flutter/material.dart';
import 'package:sqflite/sqflite.dart';
import 'package:path/path.dart';

void main() {
  runApp(const MyApp());
}

/* ===============================
   APP ROOT
================================ */
class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return const MaterialApp(
      debugShowCheckedModeBanner: false,
      home: TodoListPage(),
    );
  }
}

/* ===============================
   MODEL : Todo
   ใช้แทน List<dynamic>
================================ */
class Todo {
  final int? id;
  final String title;
  final String subtitle;
  final bool isDone;

  Todo({
    this.id,
    required this.title,
    required this.subtitle,
    required this.isDone,
  });

  // แปลง Object → Map (ไว้เก็บใน SQLite)
  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'title': title,
      'subtitle': subtitle,
      'isDone': isDone ? 1 : 0, // SQLite ไม่มี bool
    };
  }

  // แปลง Map → Object (ตอนดึงจาก DB)
  factory Todo.fromMap(Map<String, dynamic> map) {
    return Todo(
      id: map['id'],
      title: map['title'],
      subtitle: map['subtitle'],
      isDone: map['isDone'] == 1,
    );
  }
}

/* ===============================
   DATABASE HELPER (SQLite)
================================ */
class TodoDatabase {
  static final TodoDatabase instance = TodoDatabase._init();
  static Database? _database;

  TodoDatabase._init();

  // เปิด database (เปิดครั้งเดียว ใช้ซ้ำ)
  Future<Database> get database async {
    if (_database != null) return _database!;
    _database = await _initDB('todo.db');
    return _database!;
  }

  Future<Database> _initDB(String fileName) async {
    final dbPath = await getDatabasesPath();
    final path = join(dbPath, fileName);

    return await openDatabase(
      path,
      version: 1,
      onCreate: _createDB,
    );
  }

  // สร้าง table ครั้งแรก
  Future<void> _createDB(Database db, int version) async {
    await db.execute('''
      CREATE TABLE todos (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        subtitle TEXT NOT NULL,
        isDone INTEGER NOT NULL
      )
    ''');
  }

  // ---------- CRUD ----------

  Future<int> createTodo(Todo todo) async {
    final db = await database;
    return await db.insert('todos', todo.toMap());
  }

  Future<List<Todo>> getTodos() async {
    final db = await database;
    final result = await db.query('todos');
    return result.map((e) => Todo.fromMap(e)).toList();
  }

  Future<int> updateTodo(Todo todo) async {
    final db = await database;
    return await db.update(
      'todos',
      todo.toMap(),
      where: 'id = ?',
      whereArgs: [todo.id],
    );
  }

  Future<int> deleteTodo(int id) async {
    final db = await database;
    return await db.delete(
      'todos',
      where: 'id = ?',
      whereArgs: [id],
    );
  }
}

/* ===============================
   TODO LIST PAGE
================================ */
class TodoListPage extends StatefulWidget {
  const TodoListPage({super.key});

  @override
  State<TodoListPage> createState() => _TodoListPageState();
}

class _TodoListPageState extends State<TodoListPage> {
  final TextEditingController _title = TextEditingController();
  final TextEditingController _subtitle = TextEditingController();

  List<Todo> todos = [];

  @override
  void initState() {
    super.initState();
    loadTodos(); // โหลดจาก SQLite ตอนเปิดหน้า
  }

  Future<void> loadTodos() async {
    final data = await TodoDatabase.instance.getTodos();
    setState(() {
      todos = data;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Todo App (SQLite)")),
      body: ListView.builder(
        itemCount: todos.length,
        itemBuilder: (context, index) {
          final todo = todos[index];

          return ListTile(
            leading: IconButton(
              icon: const Icon(Icons.delete),
              onPressed: () async {
                await TodoDatabase.instance.deleteTodo(todo.id!);
                loadTodos();
              },
            ),
            title: Text(
              todo.title,
              style: TextStyle(
                decoration:
                    todo.isDone ? TextDecoration.lineThrough : null,
              ),
            ),
            subtitle: Text(todo.subtitle),
            trailing: Checkbox(
              value: todo.isDone,
              onChanged: (value) async {
                await TodoDatabase.instance.updateTodo(
                  Todo(
                    id: todo.id,
                    title: todo.title,
                    subtitle: todo.subtitle,
                    isDone: value!,
                  ),
                );
                loadTodos();
              },
            ),
            onTap: () async {
              // ไปหน้าแก้ไข
              final result = await Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (_) => TodoDetailPage(
                    title: todo.title,
                    subtitle: todo.subtitle,
                  ),
                ),
              );

              if (result != null) {
                await TodoDatabase.instance.updateTodo(
                  Todo(
                    id: todo.id,
                    title: result['title'],
                    subtitle: result['subtitle'],
                    isDone: todo.isDone,
                  ),
                );
                loadTodos();
              }
            },
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        child: const Icon(Icons.add),
        onPressed: () {
          showDialog(
            context: context,
            builder: (_) => AlertDialog(
              title: const Text("Add Todo"),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  TextField(
                    controller: _title,
                    decoration:
                        const InputDecoration(hintText: "Title"),
                  ),
                  TextField(
                    controller: _subtitle,
                    decoration:
                        const InputDecoration(hintText: "Subtitle"),
                  ),
                ],
              ),
              actions: [
                TextButton(
                  onPressed: () async {
                    await TodoDatabase.instance.createTodo(
                      Todo(
                        title: _title.text,
                        subtitle: _subtitle.text,
                        isDone: false,
                      ),
                    );
                    _title.clear();
                    _subtitle.clear();
                    Navigator.pop(context);
                    loadTodos();
                  },
                  child: const Text("Add"),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}

/* ===============================
   TODO DETAIL PAGE
================================ */
class TodoDetailPage extends StatelessWidget {
  final String title;
  final String subtitle;

  const TodoDetailPage({
    super.key,
    required this.title,
    required this.subtitle,
  });

  @override
  Widget build(BuildContext context) {
    final titleCtrl = TextEditingController(text: title);
    final subtitleCtrl = TextEditingController(text: subtitle);

    return Scaffold(
      appBar: AppBar(title: const Text("Edit Todo")),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(controller: titleCtrl),
            TextField(controller: subtitleCtrl),
            const SizedBox(height: 16),
            ElevatedButton(
              onPressed: () {
                Navigator.pop(context, {
                  'title': titleCtrl.text,
                  'subtitle': subtitleCtrl.text,
                });
              },
              child: const Text("Save"),
            ),
          ],
        ),
      ),
    );
  }
}
